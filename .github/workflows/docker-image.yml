name: CI

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Ejecuta en cada push y pull-request
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

permissions:
  contents: read
  packages: write           # necesario para subir la imagen

env:
  PYTHON_VERSION: "3.12"
  DOCKER_IMAGE: ghcr.io/${{ github.repository }}:latest

# â€¦ ðŸ‘† mismas claves 'name', 'on', 'permissions', 'env' â€¦

jobs:
  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports: ["5432:5432"]
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: âš¡ Install uv (and cache)
        uses: astral-sh/setup-uv@v6      # acciÃ³n oficial :contentReference[oaicite:0]{index=0}

      # â”€â”€â”€ Instalar dependencias â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ“¦ Instalar deps declaradas en pyproject.toml
        shell: bash
        run: |
          # Dependencias de producciÃ³n + el propio paquete
          uv pip install -e .                      # editable        :contentReference[oaicite:1]{index=1}
          # Extras de desarrollo y test (si existen)
          uv pip install -e ".[dev,test]" || true  # ignora si no hay esas extras

      # â”€â”€â”€ Linters, MyPy, tests, cobertura â€¦ (sin cambios) â”€â”€â”€

      # â”€â”€â”€ Linters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ§¹ Ruff (estilo + lint)
        run: ruff check .

      - name: ðŸ” MyPy (tipo estÃ¡tico)
        run: mypy app

      # â”€â”€â”€ Tests â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ§ª Pytest con cobertura
        run: |
          pytest -m "not e2e" -n auto --cov=app --cov-report=xml

      - name: ðŸ§ª Pytest E2E (marca e2e)
        run: |
          pytest -m e2e --maxfail=1 --dist=loadfile -n auto

      # â”€â”€â”€ Artefactos & cobertura â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ“¤ Subir cobertura a cobertura.io (opcional)
        if: ${{ github.ref == 'refs/heads/main' }}
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.xml

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 2. Job de build & push Docker
#    (sÃ³lo si todo lo anterior pasa)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  docker:
    needs: test
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ³ Set up QEMU (multi-arch opcional)
        uses: docker/setup-qemu-action@v3

      - name: ðŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ”‘ Login al Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ—ï¸ Construir y subir imagen
        uses: docker/build-push-action@v5
        with:
          context: .
          target: prod                    # si tu Dockerfile tiene multi-stage
          push: true
          tags: ${{ env.DOCKER_IMAGE }}

      # â”€â”€â”€ Publicar resumen â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ“„ Summary
        run: echo "Imagen subida como ${{ env.DOCKER_IMAGE }}" >> $GITHUB_STEP_SUMMARY
